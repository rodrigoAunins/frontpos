<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Ventas - Maquillaje</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-ku/ud6Sd9ch9R+OOWKoYwS+W8Re3E2kZvv1sBmqf3lgh+Pmpu1clyZ6lrzNKo6xJji1N1XNCYFHE1CukZ8+1Lg=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Librería para escaneo con cámara -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
  <!-- jsPDF para generar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS para exportar a Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* Estilos generales y modernos */
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f7fc;
      margin: 0;
      padding: 0;
    }
    .btn, input, select, textarea { font-size: 1rem; }
    .card .card-body h6 { font-size: 1rem; }

    /* Login */
    #loginPage {
      max-width: 400px; 
      margin: 80px auto; 
      background: #fff;
      padding: 30px; 
      border-radius: 10px; 
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }

    /* Navbar personalizada */
    .navbar { background: #2c3e50; }
    .navbar-brand, .navbar-text, .nav-link, .navbar-toggler-icon { color: #ecf0f1 !important; }
    .nav-link:hover { color: #bdc3c7 !important; }

    /* Botones personalizados */
    .btn-custom { border-radius: 25px; padding: 0.6rem 1.2rem; }

    /* Tarjetas */
    .card { border: none; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-img-top { border-top-left-radius: 10px; border-top-right-radius: 10px; height: 180px; object-fit: cover; }
    .category-card, .product-card, .brand-card { cursor: pointer; transition: transform 0.2s; }
    .category-card:hover, .product-card:hover, .brand-card:hover { transform: scale(1.03); }

    /* Resumen de venta */
    #saleSummary { background: #ecf0f1; padding: 15px; border-radius: 10px; }

    /* Tablas */
    table th, table td { vertical-align: middle !important; }

    /* Secciones de reportes */
    .report-section { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }

    /* Modal custom */
    .custom-modal .modal-content { border-radius: 10px; }
    .modal-dialog.modal-dialog-centered { max-width: 600px; }
    .modal-lg { max-width: 800px; }

    /* Ocultar contenedor de cámara por defecto */
    #cameraScannerContainer { display: none; }
  </style>
</head>
<body>

  <!-- Página de Login -->
  <div id="loginPage" class="container">
    <h2 class="text-center mb-4"><i class="fa-solid fa-sign-in-alt"></i> Ingresar</h2>
    <form id="loginForm">
      <div class="form-group">
        <label for="loginUsername">Usuario</label>
        <input type="text" id="loginUsername" class="form-control" placeholder="Ingrese usuario" required>
      </div>
      <div class="form-group">
        <label for="loginPassword">Contraseña</label>
        <input type="password" id="loginPassword" class="form-control" placeholder="Ingrese contraseña" required>
      </div>
      <button type="submit" class="btn btn-primary btn-block btn-custom">Ingresar</button>
    </form>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none;">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-makeup-brush"></i> Maquillaje POS</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
        <span class="navbar-toggler-icon"><i class="fa-solid fa-bars"></i></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto" id="menuNav"></ul>
        <span class="navbar-text" id="currentUser"></span>
        <button id="logoutBtn" class="btn btn-outline-light ml-2 btn-custom">
          <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
        </button>
      </div>
    </nav>
    <!-- Área de contenido -->
    <div id="contentArea" class="container mt-4"></div>
  </div>

  <!-- Modal para seleccionar cantidad de producto (Ventas) -->
  <div class="modal fade custom-modal" id="quantityModal" tabindex="-1" role="dialog" aria-labelledby="quantityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="quantityModalLabel" class="modal-title">Agregar Producto</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p id="selectedProductName"></p>
          <div class="form-group">
            <label for="productQuantity">Cantidad</label>
            <input type="number" id="productQuantity" class="form-control" min="1" value="1">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="confirmQuantityBtn" class="btn btn-success btn-custom">Agregar</button>
          <button type="button" class="btn btn-secondary btn-custom" data-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar producto (Admin) -->
  <div class="modal fade custom-modal" id="editProductModal" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <form id="editProductForm">
          <div class="modal-header">
            <h5 id="editProductModalLabel" class="modal-title">Editar Producto</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editProductId">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Nombre</label>
                <input type="text" id="editProductName" class="form-control" required>
              </div>
              <div class="form-group col-md-6">
                <label>Precio</label>
                <input type="number" id="editProductPrice" class="form-control" required>
              </div>
            </div>
            <div class="form-group">
              <label>Descripción</label>
              <textarea id="editProductDescription" class="form-control"></textarea>
            </div>
            <div class="form-row">
              <div class="form-group col-md-3">
                <label>Stock</label>
                <input type="number" id="editProductStock" class="form-control" required>
              </div>
              <div class="form-group col-md-3">
                <label>Categoría</label>
                <select id="editProductCategory" class="form-control" required></select>
              </div>
              <div class="form-group col-md-3">
                <label>Marca</label>
                <select id="editProductBrand" class="form-control" required></select>
              </div>
              <div class="form-group col-md-3">
                <label>Código de barras</label>
                <input type="text" id="editProductBarcode" class="form-control">
              </div>
            </div>
            <div class="form-group">
              <label>Imagen</label>
              <input type="file" id="editProductImage" accept="image/*" class="form-control-file">
            </div>
            <div id="currentProductImage" class="text-center mb-2"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success btn-custom">
              <i class="fa-solid fa-check"></i> Actualizar
            </button>
            <button type="button" class="btn btn-secondary btn-custom" data-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para procesar pago y generar factura (Ventas) -->
  <div class="modal fade custom-modal" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="paymentModalLabel" class="modal-title">Procesar Pago y Generar Factura</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="invoiceDetails"></div>
          <div class="form-group">
            <label for="amountPaid">Monto Recibido del Cliente</label>
            <input type="number" id="amountPaid" class="form-control" min="0" step="0.01" placeholder="Ingrese el monto recibido">
          </div>
          <div class="form-group">
            <label for="paymentMethod">Tipo de Pago</label>
            <select id="paymentMethod" class="form-control">
              <option value="efectivo">Efectivo</option>
              <option value="debito">Tarjeta de Débito</option>
              <option value="credito">Tarjeta de Crédito</option>
            </select>
          </div>
          <div>
            <p>Devolución: $<span id="changeDue">0.00</span></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="processPaymentBtn" class="btn btn-success btn-custom">Procesar Pago e Imprimir Factura</button>
          <button type="button" class="btn btn-secondary btn-custom" data-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar Categoría (Admin) -->
  <div class="modal fade custom-modal" id="editCategoryModal" tabindex="-1" role="dialog" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <form id="editCategoryForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editCategoryModalLabel">Editar Categoría</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editCategoryId">
            <div class="form-group">
              <label>Nombre de la Categoría</label>
              <input type="text" id="editCategoryName" class="form-control" required>
            </div>
            <div class="form-group">
              <label>Imagen de la Categoría</label>
              <input type="file" id="editCategoryImage" accept="image/*" class="form-control-file">
            </div>
            <div id="currentCategoryImage" class="text-center mb-2"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success btn-custom">
              <i class="fa-solid fa-check"></i> Actualizar
            </button>
            <button type="button" class="btn btn-secondary btn-custom" data-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para editar Marca (Admin) -->
  <div class="modal fade custom-modal" id="editBrandModal" tabindex="-1" role="dialog" aria-labelledby="editBrandModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <form id="editBrandForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editBrandModalLabel">Editar Marca</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editBrandId">
            <div class="form-group">
              <label>Nombre de la Marca</label>
              <input type="text" id="editBrandName" class="form-control" required>
            </div>
            <div class="form-group">
              <label>Categoría</label>
              <select id="editBrandCategory" class="form-control" required>
                <!-- Se llenará dinámicamente -->
              </select>
            </div>
            <div class="form-group">
              <label>Imagen de la Marca</label>
              <input type="file" id="editBrandImage" accept="image/*" class="form-control-file">
            </div>
            <div id="currentBrandImage" class="text-center mb-2"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success btn-custom">
              <i class="fa-solid fa-check"></i> Actualizar
            </button>
            <button type="button" class="btn btn-secondary btn-custom" data-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Contenedor de cámara para escaneo de código -->
  <div id="cameraScannerContainer" class="container mt-3">
    <h5><i class="fa-solid fa-camera"></i> Escaneo con Cámara</h5>
    <div id="reader" style="width: 320px; margin-bottom: 10px;"></div>
    <button class="btn btn-sm btn-danger" onclick="stopCameraScanner()">Detener Cámara</button>
  </div>

  <!-- Bootstrap JS, jQuery y Popper.js -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <!-- Código JavaScript principal -->
  <script>
  /******************************************************
   *           Variables Globales
   ******************************************************/
  let currentUser = null;
  let currentSession = null;  // Para la "caja"
  let saleItems = [];
  let selectedProduct = null;
  let currentSaleCategory = null;
  let currentSaleBrand = null;
  let currentSaleTotal = 0;
  let barcodeBuffer = "";
  let barcodeTimeout = null;
  let html5QrcodeScanner = null;
  let cameraIsActive = false;

  // Ajusta al dominio de tu backend
  const BACKEND_URL = "https://posback-production.up.railway.app";

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById("loginForm").addEventListener("submit", login);
    document.getElementById("logoutBtn").addEventListener("click", logout);
    document.getElementById("confirmQuantityBtn").addEventListener("click", confirmAddProduct);
    document.getElementById("editProductForm").addEventListener("submit", updateProduct);
    document.getElementById("amountPaid").addEventListener("input", updateChangeDue);
    document.getElementById("processPaymentBtn").addEventListener("click", processPayment);
    document.getElementById("paymentMethod").addEventListener("change", function(){
      if(this.value === "debito" || this.value === "credito"){
         document.getElementById("amountPaid").value = currentSaleTotal.toFixed(2);
         document.getElementById("amountPaid").disabled = true;
         updateChangeDue();
      } else {
         document.getElementById("amountPaid").disabled = false;
      }
    });
    document.addEventListener("keydown", globalKeyHandler);
    // Nada de sync offline: se quita el setInterval de sincronización
  });

  /******************************************************
   *       Manejo de Cámara
   ******************************************************/
  function startCameraScanner() {
    if (cameraIsActive) return;
    document.getElementById("cameraScannerContainer").style.display = "block";
    cameraIsActive = true;
    html5QrcodeScanner = new Html5Qrcode("reader");
    html5QrcodeScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => { findProductByBarcode(decodedText.trim()); },
      (errorMessage) => {}
    ).catch((err) => console.error("Error iniciando cámara:", err));
  }

  function stopCameraScanner() {
    if (!cameraIsActive || !html5QrcodeScanner) return;
    html5QrcodeScanner.stop().then(() => {
      html5QrcodeScanner.clear();
      document.getElementById("cameraScannerContainer").style.display = "none";
      cameraIsActive = false;
    }).catch((err) => console.error("Error deteniendo cámara:", err));
  }

  /******************************************************
   *            Login / Logout
   ******************************************************/
  async function login(e) {
    e.preventDefault();
    const username = document.getElementById("loginUsername").value;
    const password = document.getElementById("loginPassword").value;

    // Ejemplo naive: GET /users y filtramos
    // En un sistema real deberías implementar un endpoint /login con tu lógica
    try {
      const resp = await fetch(`${BACKEND_URL}/users`);
      const users = await resp.json();
      const user = users.find(u => u.username === username && u.password === password);
      if (user) {
        currentUser = user;
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("currentUser").textContent = user.username + " (" + user.role + ")";
        loadMenu();
        if (currentUser.role === "admin") {
          loadPage("usuarios");
        } else {
          loadPage("caja");
        }
      } else {
        alert("Credenciales incorrectas");
      }
    } catch (error) {
      console.error("Error al realizar login:", error);
      alert("No se pudo iniciar sesión. Ver consola.");
    }
  }

  function logout() {
    // Control: si es cajero y tiene caja abierta, forzar cierre primero
    if (currentUser && currentUser.role === "cashier" && currentSession) {
      alert("Debe cerrar la caja antes de salir.");
      return;
    }
    currentUser = null;
    currentSession = null;
    saleItems = [];
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("loginPage").style.display = "block";
  }

  /******************************************************
   *                     Menú
   ******************************************************/
  function loadMenu() {
    const menuNav = document.getElementById("menuNav");
    menuNav.innerHTML = "";
    if (currentUser.role === "admin") {
      menuNav.innerHTML += `<li class="nav-item"><a class="nav-link" href="#" data-page="usuarios"><i class="fa-solid fa-users"></i> Usuarios</a></li>`;
      menuNav.innerHTML += `<li class="nav-item"><a class="nav-link" href="#" data-page="categorias"><i class="fa-solid fa-tags"></i> Categorías</a></li>`;
      menuNav.innerHTML += `<li class="nav-item"><a class="nav-link" href="#" data-page="marcas"><i class="fa-solid fa-tag"></i> Marcas</a></li>`;
      menuNav.innerHTML += `<li class="nav-item"><a class="nav-link" href="#" data-page="productos"><i class="fa-solid fa-boxes-stacked"></i> Productos</a></li>`;
      menuNav.innerHTML += `<li class="nav-item"><a class="nav-link" href="#" data-page="reportes"><i class="fa-solid fa-chart-line"></i> Reportes</a></li>`;
    } else if (currentUser.role === "cashier") {
      menuNav.innerHTML += `<li class="nav-item"><a class="nav-link" href="#" data-page="caja"><i class="fa-solid fa-cash-register"></i> Caja</a></li>`;
      menuNav.innerHTML += `<li class="nav-item"><a class="nav-link" href="#" data-page="ventas"><i class="fa-solid fa-shopping-cart"></i> Ventas</a></li>`;
      menuNav.innerHTML += `<li class="nav-item"><button class="btn btn-sm btn-info ml-2" onclick="startCameraScanner()"><i class="fa-solid fa-camera"></i> Leer con Cámara</button></li>`;
    }
    document.querySelectorAll("#menuNav a.nav-link").forEach(link => {
      link.addEventListener("click", function(e) {
        e.preventDefault();
        loadPage(this.getAttribute("data-page"));
      });
    });
  }

  /******************************************************
   *                Carga de Páginas
   ******************************************************/
  function loadPage(page) {
    const contentArea = document.getElementById("contentArea");
    contentArea.innerHTML = "";
    switch (page) {
      case "usuarios":   renderUsuariosPage();   break;
      case "categorias": renderCategoriasPage(); break;
      case "marcas":     renderMarcasPage();     break;
      case "productos":  renderProductosPage();  break;
      case "ventas":     renderVentasPage();     break;
      case "caja":       renderCajaPage();       break;
      case "reportes":   renderReportesPage();   break;
      default:
        contentArea.innerHTML = "<p>Página no encontrada</p>";
    }
  }

  /******************************************************
   *    Gestión de Usuarios (Admin)
   ******************************************************/
  function renderUsuariosPage() {
    const contentArea = document.getElementById("contentArea");
    contentArea.innerHTML = `
      <h3><i class="fa-solid fa-users"></i> Gestión de Usuarios</h3>
      <form id="userForm" class="mb-4">
        <div class="form-group">
          <label>Usuario</label>
          <input type="text" id="newUsername" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Contraseña</label>
          <input type="password" id="newPassword" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Rol</label>
          <select id="newRole" class="form-control">
            <option value="admin">Admin</option>
            <option value="cashier">Cajero</option>
          </select>
        </div>
        <button type="submit" class="btn btn-success btn-custom">Agregar Usuario</button>
      </form>
      <h4>Usuarios existentes</h4>
      <table class="table table-bordered">
        <thead>
          <tr><th>ID</th><th>Usuario</th><th>Rol</th><th>Acciones</th></tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      </table>`;

    document.getElementById("userForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const username = document.getElementById("newUsername").value;
      const password = document.getElementById("newPassword").value;
      const role = document.getElementById("newRole").value;
      try {
        await fetch(`${BACKEND_URL}/users`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, role })
        });
        this.reset();
        loadUsuariosTable();
      } catch (error) {
        console.error("Error creando usuario:", error);
        alert("Error creando usuario.");
      }
    });
    loadUsuariosTable();
  }

  async function loadUsuariosTable() {
    const tbody = document.getElementById("usersTableBody");
    try {
      const resp = await fetch(`${BACKEND_URL}/users`);
      const users = await resp.json();
      tbody.innerHTML = "";
      users.forEach(u => {
        tbody.innerHTML += `
          <tr>
            <td>${u.id}</td>
            <td>${u.username}</td>
            <td>${u.role}</td>
            <td>
              <button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">
                <i class="fa-solid fa-trash"></i> Borrar
              </button>
            </td>
          </tr>`;
      });
    } catch (error) {
      console.error("Error cargando usuarios:", error);
      tbody.innerHTML = "<tr><td colspan='4'>No se pudo cargar usuarios</td></tr>";
    }
  }

  window.deleteUser = async function(id) {
    if (!confirm("¿Está seguro de eliminar este usuario?")) return;
    try {
      await fetch(`${BACKEND_URL}/users/${id}`, { method: "DELETE" });
      loadUsuariosTable();
    } catch (error) {
      console.error("Error eliminando usuario:", error);
      alert("No se pudo eliminar el usuario.");
    }
  };

  /******************************************************
   *    Gestión de Categorías (Admin)
   ******************************************************/
  function renderCategoriasPage() {
    const contentArea = document.getElementById("contentArea");
    contentArea.innerHTML = `
      <h3><i class="fa-solid fa-tags"></i> Gestión de Categorías</h3>
      <form id="categoryForm" class="mb-4">
        <div class="form-group">
          <label>Nombre de Categoría</label>
          <input type="text" id="categoryName" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Imagen de Categoría</label>
          <input type="file" id="categoryImage" accept="image/*" class="form-control-file" required>
        </div>
        <button type="submit" class="btn btn-success btn-custom">Agregar Categoría</button>
      </form>
      <h4>Categorías</h4>
      <div class="row" id="categoriesList"></div>`;

    document.getElementById("categoryForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const name = document.getElementById("categoryName").value;
      const fileInput = document.getElementById("categoryImage");
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async function(ev) {
          const imageData = ev.target.result;
          try {
            await fetch(`${BACKEND_URL}/categories`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, image: imageData })
            });
            document.getElementById("categoryForm").reset();
            loadCategoriesList();
          } catch (error) {
            console.error("Error creando categoría:", error);
            alert("Error creando categoría.");
          }
        };
        reader.readAsDataURL(file);
      }
    });

    loadCategoriesList();
  }

  async function loadCategoriesList() {
    const list = document.getElementById("categoriesList");
    list.innerHTML = "";
    try {
      const resp = await fetch(`${BACKEND_URL}/categories`);
      const categories = await resp.json();
      if (categories.length === 0) {
        list.innerHTML = '<div class="col-12 text-center text-muted">No hay categorías registradas.</div>';
        return;
      }
      categories.forEach(cat => {
        list.innerHTML += `
          <div class="col-md-3">
            <div class="card category-card">
              <img src="${cat.image}" class="card-img-top" alt="${cat.name}">
              <div class="card-body text-center">
                <h5 class="card-title">${cat.name}</h5>
                <button class="btn btn-sm btn-primary" onclick="editCategory('${cat.id}')">
                  <i class="bi bi-pencil-square"></i> Editar
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.id}')">
                  <i class="fa-solid fa-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>`;
      });
    } catch (error) {
      console.error("Error cargando categorías:", error);
      list.innerHTML = "<div class='col-12 text-danger'>No se pudieron cargar las categorías.</div>";
    }
  }

  window.editCategory = async function(id) {
    try {
      const resp = await fetch(`${BACKEND_URL}/categories`);
      const categories = await resp.json();
      const cat = categories.find(c => c.id == id);
      if (!cat) return;
      document.getElementById("editCategoryId").value = cat.id;
      document.getElementById("editCategoryName").value = cat.name;
      if (cat.image) {
        document.getElementById("currentCategoryImage").innerHTML = `<img src="${cat.image}" alt="${cat.name}" style="width:100px;height:100px;object-fit:cover;">`;
      } else {
        document.getElementById("currentCategoryImage").innerHTML = "";
      }
      $("#editCategoryModal").modal("show");
    } catch (error) {
      console.error("Error obteniendo categorías para edición:", error);
    }
  };

  window.deleteCategory = async function(id) {
    if (!confirm("¿Está seguro de eliminar esta categoría?")) return;
    try {
      await fetch(`${BACKEND_URL}/categories/${id}`, { method: "DELETE" });
      loadCategoriesList();
    } catch (error) {
      console.error("Error eliminando categoría:", error);
      alert("No se pudo eliminar la categoría.");
    }
  };

  document.getElementById("editCategoryForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const id = document.getElementById("editCategoryId").value;
    const name = document.getElementById("editCategoryName").value;
    const fileInput = document.getElementById("editCategoryImage");
    try {
      let imageData = null;
      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = async function(ev) {
          imageData = ev.target.result;
          await fetch(`${BACKEND_URL}/categories/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, image: imageData })
          });
          $("#editCategoryModal").modal("hide");
          loadCategoriesList();
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        await fetch(`${BACKEND_URL}/categories/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        });
        $("#editCategoryModal").modal("hide");
        loadCategoriesList();
      }
    } catch (error) {
      console.error("Error actualizando categoría:", error);
      alert("No se pudo actualizar la categoría.");
    }
  });

  /******************************************************
   *    Gestión de Marcas (Admin)
   ******************************************************/
  function renderMarcasPage() {
    const contentArea = document.getElementById("contentArea");
    contentArea.innerHTML = `
      <h3><i class="fa-solid fa-tag"></i> Gestión de Marcas</h3>
      <form id="brandForm" class="mb-4">
        <div class="form-group">
          <label>Nombre de la Marca</label>
          <input type="text" id="brandName" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Categoría a la que pertenece</label>
          <select id="brandCategory" class="form-control" required></select>
        </div>
        <div class="form-group">
          <label>Imagen de la Marca</label>
          <input type="file" id="brandImage" accept="image/*" class="form-control-file" required>
        </div>
        <button type="submit" class="btn btn-success btn-custom">Agregar Marca</button>
      </form>
      <h4>Marcas</h4>
      <div class="row" id="brandsList"></div>`;

    document.getElementById("brandForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const name = document.getElementById("brandName").value;
      const categoryId = document.getElementById("brandCategory").value.trim();
      const fileInput = document.getElementById("brandImage");
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async function(ev) {
          const imageData = ev.target.result;
          try {
            await fetch(`${BACKEND_URL}/brands`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, categoryId, image: imageData })
            });
            document.getElementById("brandForm").reset();
            loadBrandsList();
          } catch (error) {
            console.error("Error creando marca:", error);
            alert("Error creando marca.");
          }
        };
        reader.readAsDataURL(file);
      }
    });

    loadBrandCategoryDropdown();
    loadBrandsList();
  }

  async function loadBrandCategoryDropdown() {
    const select = document.getElementById("brandCategory");
    select.innerHTML = "";
    try {
      const resp = await fetch(`${BACKEND_URL}/categories`);
      const categories = await resp.json();
      if (categories.length === 0) {
        select.innerHTML = "<option value=''>No hay categorías</option>";
        return;
      }
      categories.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
      });
    } catch (error) {
      console.error("Error cargando categorías en marcas:", error);
      select.innerHTML = "<option value=''>Error cargando categorías</option>";
    }
  }

  async function loadBrandsList() {
    const list = document.getElementById("brandsList");
    if (!list) return;
    list.innerHTML = "";
    try {
      const resp = await fetch(`${BACKEND_URL}/brands`);
      const brands = await resp.json();
      if (brands.length === 0) {
        list.innerHTML = '<div class="col-12 text-center text-muted">No hay marcas registradas.</div>';
        return;
      }
      // También necesitamos las categorías para mostrar el nombre
      const catResp = await fetch(`${BACKEND_URL}/categories`);
      const categories = await catResp.json();

      brands.forEach(brand => {
        const cat = categories.find(c => c.id == brand.categoryId);
        const catName = cat ? cat.name : "Sin categoría";
        list.innerHTML += `
          <div class="col-md-3">
            <div class="card brand-card">
              <img src="${brand.image}" class="card-img-top" alt="${brand.name}">
              <div class="card-body text-center">
                <h5 class="card-title">${brand.name}</h5>
                <p class="card-text"><small>Categoría: ${catName}</small></p>
                <button class="btn btn-sm btn-primary" onclick="editBrand('${brand.id}')">
                  <i class="bi bi-pencil-square"></i> Editar
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteBrand('${brand.id}')">
                  <i class="fa-solid fa-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>`;
      });
    } catch (error) {
      console.error("Error cargando marcas:", error);
      list.innerHTML = "<div class='col-12 text-danger'>No se pudieron cargar las marcas.</div>";
    }
  }

  window.editBrand = async function(id) {
    try {
      const resp = await fetch(`${BACKEND_URL}/brands`);
      const brands = await resp.json();
      const brand = brands.find(b => b.id == id);
      if (!brand) return;
      document.getElementById("editBrandId").value = brand.id;
      document.getElementById("editBrandName").value = brand.name;

      // Cargar categorías
      const catResp = await fetch(`${BACKEND_URL}/categories`);
      const categories = await catResp.json();
      const select = document.getElementById("editBrandCategory");
      select.innerHTML = "";
      categories.forEach(c => {
        select.innerHTML += `<option value="${c.id}" ${c.id == brand.categoryId ? "selected" : ""}>${c.name}</option>`;
      });
      if (brand.image) {
        document.getElementById("currentBrandImage").innerHTML = `<img src="${brand.image}" alt="${brand.name}" style="width:100px;height:100px;object-fit:cover;">`;
      } else {
        document.getElementById("currentBrandImage").innerHTML = '';
      }
      $("#editBrandModal").modal("show");
    } catch (error) {
      console.error("Error al editar marca:", error);
    }
  };

  window.deleteBrand = async function(id) {
    if (!confirm("¿Está seguro de eliminar esta marca?")) return;
    try {
      await fetch(`${BACKEND_URL}/brands/${id}`, { method: "DELETE" });
      loadBrandsList();
    } catch (error) {
      console.error("Error eliminando marca:", error);
      alert("No se pudo eliminar la marca.");
    }
  };

  document.getElementById("editBrandForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const id = document.getElementById("editBrandId").value;
    const name = document.getElementById("editBrandName").value;
    const categoryId = document.getElementById("editBrandCategory").value.trim();
    const fileInput = document.getElementById("editBrandImage");
    try {
      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = async function(ev) {
          const imageData = ev.target.result;
          await fetch(`${BACKEND_URL}/brands/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, categoryId, image: imageData })
          });
          $("#editBrandModal").modal("hide");
          loadBrandsList();
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        await fetch(`${BACKEND_URL}/brands/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, categoryId })
        });
        $("#editBrandModal").modal("hide");
        loadBrandsList();
      }
    } catch (error) {
      console.error("Error actualizando marca:", error);
      alert("No se pudo actualizar la marca.");
    }
  });

  /******************************************************
   *    Gestión de Productos (Admin)
   ******************************************************/
  function renderProductosPage() {
    const contentArea = document.getElementById("contentArea");
    contentArea.innerHTML = `
      <h3><i class="fa-solid fa-boxes-stacked"></i> Gestión de Productos</h3>
      <form id="productForm" class="mb-4">
        <div class="form-group">
          <label>Nombre del Producto</label>
          <input type="text" id="productName" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Descripción</label>
          <textarea id="productDescription" class="form-control"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group col-md-3">
            <label>Precio</label>
            <input type="number" id="productPrice" class="form-control" required>
          </div>
          <div class="form-group col-md-3">
            <label>Stock</label>
            <input type="number" id="productStock" class="form-control" required>
          </div>
          <div class="form-group col-md-3">
            <label>Categoría</label>
            <select id="productCategory" class="form-control" required></select>
          </div>
          <div class="form-group col-md-3">
            <label>Marca</label>
            <select id="productBrand" class="form-control" required></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>Código de Barras</label>
            <input type="text" id="productBarcode" class="form-control">
          </div>
          <div class="form-group col-md-6">
            <label>Imagen del Producto</label>
            <input type="file" id="productImage" accept="image/*" class="form-control-file" required>
          </div>
        </div>
        <button type="submit" class="btn btn-success btn-custom">Agregar Producto</button>
      </form>
      <h4>Productos</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>Marca</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Código de Barras</th>
            <th>Imagen</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="productsTableBody"></tbody>
      </table>`;

    // Carga de combos
    loadProductCategoryDropdown();
    document.getElementById("productCategory").addEventListener("change", loadProductBrandDropdown);

    // Evento submit
    document.getElementById("productForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const name = document.getElementById("productName").value;
      const description = document.getElementById("productDescription").value;
      const price = parseFloat(document.getElementById("productPrice").value);
      const stock = parseInt(document.getElementById("productStock").value);
      const categoryId = document.getElementById("productCategory").value.trim();
      const brandId = document.getElementById("productBrand").value.trim();
      const barcode = document.getElementById("productBarcode").value.trim();
      const fileInput = document.getElementById("productImage");
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async function(ev) {
          const imageData = ev.target.result;
          try {
            await fetch(`${BACKEND_URL}/products`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, description, price, stock, categoryId, brandId, barcode, image: imageData })
            });
            document.getElementById("productForm").reset();
            loadProductsTable();
          } catch (error) {
            console.error("Error creando producto:", error);
            alert("No se pudo crear el producto.");
          }
        };
        reader.readAsDataURL(file);
      }
    });

    loadProductsTable();
  }

  async function loadProductCategoryDropdown() {
    const productCategorySelect = document.getElementById("productCategory");
    productCategorySelect.innerHTML = "";
    try {
      const resp = await fetch(`${BACKEND_URL}/categories`);
      const categories = await resp.json();
      if (categories.length === 0) {
        productCategorySelect.innerHTML = "<option value=''>No hay categorías</option>";
        return;
      }
      categories.forEach(cat => {
        productCategorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
      });
      loadProductBrandDropdown();  // para refrescar marca según primera categoría
    } catch (error) {
      console.error("Error cargando categorías en productos:", error);
      productCategorySelect.innerHTML = "<option value=''>Error cargando categorías</option>";
    }
  }

  async function loadProductBrandDropdown() {
    const productBrandSelect = document.getElementById("productBrand");
    productBrandSelect.innerHTML = "";
    const categorySelected = document.getElementById("productCategory").value.trim();
    if (!categorySelected) {
      productBrandSelect.innerHTML = "<option value=''>No hay marcas para esta categoría</option>";
      return;
    }
    try {
      const resp = await fetch(`${BACKEND_URL}/brands`);
      const allBrands = await resp.json();
      const filteredBrands = allBrands.filter(b => b.categoryId == categorySelected);
      if (filteredBrands.length === 0) {
        productBrandSelect.innerHTML = "<option value=''>No hay marcas para esta categoría</option>";
      } else {
        filteredBrands.forEach(b => {
          productBrandSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
        });
      }
    } catch (error) {
      console.error("Error cargando marcas en productos:", error);
      productBrandSelect.innerHTML = "<option value=''>Error cargando marcas</option>";
    }
  }

  async function loadProductsTable() {
    const tbody = document.getElementById("productsTableBody");
    tbody.innerHTML = "";
    try {
      const resp = await fetch(`${BACKEND_URL}/products`);
      const products = await resp.json();
      const catResp = await fetch(`${BACKEND_URL}/categories`);
      const categories = await catResp.json();
      const brResp = await fetch(`${BACKEND_URL}/brands`);
      const brands = await brResp.json();

      products.forEach(prod => {
        const category = categories.find(c => c.id == prod.categoryId);
        const brand = brands.find(br => br.id == prod.brandId);
        tbody.innerHTML += `
          <tr>
            <td>${prod.id}</td>
            <td>${prod.name}</td>
            <td>${category ? category.name : ''}</td>
            <td>${brand ? brand.name : ''}</td>
            <td>$${prod.price}</td>
            <td>${prod.stock}</td>
            <td>${prod.barcode || ''}</td>
            <td><img src="${prod.image}" alt="${prod.name}" style="width:50px;height:50px;object-fit:cover;"></td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="editProduct('${prod.id}')">
                <i class="fa-solid fa-edit"></i> Editar
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteProduct('${prod.id}')">
                <i class="fa-solid fa-trash"></i> Eliminar
              </button>
            </td>
          </tr>`;
      });
    } catch (error) {
      console.error("Error cargando productos:", error);
      tbody.innerHTML = "<tr><td colspan='9'>No se pudo cargar productos</td></tr>";
    }
  }

  window.deleteProduct = async function(id) {
    if (!confirm("¿Está seguro de eliminar este producto?")) return;
    try {
      await fetch(`${BACKEND_URL}/products/${id}`, { method: "DELETE" });
      loadProductsTable();
    } catch (error) {
      console.error("Error al eliminar producto:", error);
      alert("No se pudo eliminar el producto.");
    }
  };

  window.editProduct = async function(id) {
    try {
      // Obtener producto
      const resp = await fetch(`${BACKEND_URL}/products`);
      const products = await resp.json();
      const prod = products.find(p => p.id == id);
      if (!prod) return;

      // Llenar formulario
      document.getElementById("editProductId").value = prod.id;
      document.getElementById("editProductName").value = prod.name;
      document.getElementById("editProductDescription").value = prod.description;
      document.getElementById("editProductPrice").value = prod.price;
      document.getElementById("editProductStock").value = prod.stock;
      document.getElementById("editProductBarcode").value = prod.barcode || "";
      if (prod.image) {
        document.getElementById("currentProductImage").innerHTML = `<img src="${prod.image}" alt="${prod.name}" style="width:100px;height:100px;object-fit:cover;">`;
      } else {
        document.getElementById("currentProductImage").innerHTML = "";
      }

      // Cargar categorías
      const catResp = await fetch(`${BACKEND_URL}/categories`);
      const categories = await catResp.json();
      const selectCat = document.getElementById("editProductCategory");
      selectCat.innerHTML = categories.map(c =>
        `<option value="${c.id}" ${c.id == prod.categoryId ? 'selected' : ''}>${c.name}</option>`
      ).join("");

      // Cargar marcas
      const brResp = await fetch(`${BACKEND_URL}/brands`);
      const brandOptions = await brResp.json();
      const filteredOptions = brandOptions.filter(b => b.categoryId == prod.categoryId);
      const selectBr = document.getElementById("editProductBrand");
      selectBr.innerHTML = filteredOptions.map(b =>
        `<option value="${b.id}" ${b.id == prod.brandId ? 'selected' : ''}>${b.name}</option>`
      ).join("");

      $("#editProductModal").modal("show");

      // Evento "change" en la categoría
      selectCat.onchange = function() {
        const newCatId = this.value.trim();
        const brs = brandOptions.filter(b => b.categoryId == newCatId);
        selectBr.innerHTML = brs.map(b => `<option value="${b.id}">${b.name}</option>`).join("");
      };
    } catch (error) {
      console.error("Error al editar producto:", error);
    }
  };

  async function updateProduct(e) {
    e.preventDefault();
    const id = document.getElementById("editProductId").value;
    const name = document.getElementById("editProductName").value;
    const description = document.getElementById("editProductDescription").value;
    const price = parseFloat(document.getElementById("editProductPrice").value);
    const stock = parseInt(document.getElementById("editProductStock").value);
    const categoryId = document.getElementById("editProductCategory").value.trim();
    const brandId = document.getElementById("editProductBrand").value.trim();
    const barcode = document.getElementById("editProductBarcode").value.trim();

    const fileInput = document.getElementById("editProductImage");
    try {
      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = async function(ev) {
          const imageData = ev.target.result;
          await fetch(`${BACKEND_URL}/products/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, description, price, stock, categoryId, brandId, barcode, image: imageData })
          });
          $("#editProductModal").modal("hide");
          loadProductsTable();
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        await fetch(`${BACKEND_URL}/products/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description, price, stock, categoryId, brandId, barcode })
        });
        $("#editProductModal").modal("hide");
        loadProductsTable();
      }
    } catch (error) {
      console.error("Error actualizando producto:", error);
      alert("No se pudo actualizar el producto.");
    }
  }

  /******************************************************
   *              Página de Caja
   ******************************************************/
  function renderCajaPage() {
    const contentArea = document.getElementById("contentArea");
    contentArea.innerHTML = `
      <h3><i class="fa-solid fa-cash-register"></i> Gestión de Caja</h3>
      <div id="cajaSection">
        <div id="openCajaSection">
          <div class="form-group">
            <label>Monto Inicial</label>
            <input type="number" id="initialAmount" class="form-control" placeholder="Ingrese monto inicial">
          </div>
          <button id="openCajaBtn" class="btn btn-primary btn-custom">
            <i class="fa-solid fa-door-open"></i> Abrir Caja
          </button>
        </div>
        <div id="closeCajaSection" style="display:none;">
          <p>Caja abierta desde: <span id="cajaStartTime"></span></p>
          <p>Monto Inicial: $<span id="cajaInitial"></span></p>
          <button id="closeCajaBtn" class="btn btn-danger btn-custom">
            <i class="fa-solid fa-door-closed"></i> Cerrar Caja
          </button>
        </div>
      </div>`;

    document.getElementById("openCajaBtn").addEventListener("click", () => {
      const initialAmount = parseFloat(document.getElementById("initialAmount").value);
      if (isNaN(initialAmount)) {
        alert("Ingrese un monto inicial válido");
        return;
      }
      currentSession = {
        id: Date.now().toString(),
        cashierId: currentUser.id,
        startTime: new Date().toISOString(),
        initialAmount
      };
      updateCajaUI();
      if (currentUser.role === "cashier") { loadPage("ventas"); }
    });
    document.getElementById("closeCajaBtn").addEventListener("click", () => {
      // En tu backend podrías guardar la sesión de caja si deseas
      // Por ahora, la dejamos local
      const totalSales = 0; // re-calcular si lo deseas
      alert(`Caja cerrada. Total de ventas: $${totalSales.toFixed(2)}`);
      currentSession = null;
      updateCajaUI();
    });
    updateCajaUI();
  }

  function updateCajaUI() {
    const openSection = document.getElementById("openCajaSection");
    const closeSection = document.getElementById("closeCajaSection");
    if (currentSession) {
      openSection.style.display = "none";
      closeSection.style.display = "block";
      document.getElementById("cajaStartTime").textContent = new Date(currentSession.startTime).toLocaleString();
      document.getElementById("cajaInitial").textContent = currentSession.initialAmount.toFixed(2);
    } else {
      openSection.style.display = "block";
      closeSection.style.display = "none";
    }
  }

  /******************************************************
   *              Página de Ventas
   ******************************************************/
  function renderVentasPage() {
    if (!currentSession) {
      const contentArea = document.getElementById("contentArea");
      contentArea.innerHTML = `
        <div class="alert alert-warning text-center">
          <i class="fa-solid fa-exclamation-triangle"></i>
          Debe <a href="#" onclick="loadPage('caja')">abrir la caja</a> para iniciar ventas.
        </div>`;
      return;
    }
    saleItems = [];
    currentSaleCategory = null;
    currentSaleBrand = null;

    const contentArea = document.getElementById("contentArea");
    contentArea.innerHTML = `
      <h3><i class="fa-solid fa-shopping-cart"></i> Registrar Venta</h3>
      <div class="row">
        <div class="col-md-8">
          <h5>Categorías</h5>
          <div class="row" id="saleCategories"></div>
          <hr>
          <h5 id="titleBrands" style="display:none;">Marcas</h5>
          <div class="row" id="saleBrands"></div>
          <hr>
          <h5 id="titleProducts" style="display:none;">Productos</h5>
          <div class="row" id="saleProducts">
            <div class="col-12 text-center text-muted">
              Seleccione una categoría para ver sus marcas, y luego la marca para ver sus productos.
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <h5>Resumen de Venta</h5>
          <div id="saleSummary">
            <table class="table table-sm" id="saleItemsTable">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Cant.</th>
                  <th>Subtotal</th>
                  <th colspan="2">Redondeo</th>
                  <th>Reset</th>
                  <th>Eliminar</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <h5>Total: $<span id="saleTotal">0.00</span></h5>
            <button id="finalizeSale" class="btn btn-success btn-block btn-custom">
              <i class="fa-solid fa-check"></i> Finalizar Venta
            </button>
          </div>
        </div>
      </div>`;

    document.getElementById("finalizeSale").addEventListener("click", finalizeSale);
    loadSaleCategories();
  }

  async function loadSaleCategories() {
    const saleCategories = document.getElementById("saleCategories");
    saleCategories.innerHTML = "";
    try {
      const resp = await fetch(`${BACKEND_URL}/categories`);
      const categories = await resp.json();
      if (categories.length === 0) {
        saleCategories.innerHTML = '<div class="col-12 text-center text-muted">No hay categorías registradas.</div>';
        return;
      }
      categories.forEach(cat => {
        saleCategories.innerHTML += `
          <div class="col-md-4 mb-3">
            <div class="card category-card" onclick="selectSaleCategory('${cat.id}')">
              <img src="${cat.image}" class="card-img-top" alt="${cat.name}">
              <div class="card-body text-center">
                <h6 class="card-title">${cat.name}</h6>
              </div>
            </div>
          </div>`;
      });
    } catch (error) {
      console.error("Error cargando categorías en ventas:", error);
      saleCategories.innerHTML = "<div class='col-12 text-danger'>No se pudieron cargar categorías.</div>";
    }
  }

  window.selectSaleCategory = function(categoryId) {
    currentSaleCategory = categoryId;
    currentSaleBrand = null;
    document.getElementById("saleProducts").innerHTML = `
      <div class="col-12 text-center text-muted">Seleccione una marca para ver los productos.</div>`;
    document.getElementById("titleProducts").style.display = "none";
    loadSaleBrands(categoryId);
  };

  async function loadSaleBrands(categoryId) {
    const saleBrandsDiv = document.getElementById("saleBrands");
    const titleBrands = document.getElementById("titleBrands");
    saleBrandsDiv.innerHTML = "";
    titleBrands.style.display = "block";
    try {
      const resp = await fetch(`${BACKEND_URL}/brands`);
      const brands = await resp.json();
      const filtered = brands.filter(b => b.categoryId == categoryId);
      if (filtered.length === 0) {
        saleBrandsDiv.innerHTML = '<div class="col-12 text-center text-muted">No hay marcas para esta categoría.</div>';
        return;
      }
      filtered.forEach(br => {
        saleBrandsDiv.innerHTML += `
          <div class="col-md-4 mb-3">
            <div class="card brand-card" onclick="selectSaleBrand('${br.id}')">
              <img src="${br.image}" class="card-img-top" alt="${br.name}">
              <div class="card-body text-center">
                <h6 class="card-title">${br.name}</h6>
              </div>
            </div>
          </div>`;
      });
    } catch (error) {
      console.error("Error cargando marcas para ventas:", error);
      saleBrandsDiv.innerHTML = "<div class='col-12 text-danger'>No se pudieron cargar las marcas.</div>";
    }
  }

  window.selectSaleBrand = function(brandId) {
    currentSaleBrand = brandId;
    document.getElementById("titleProducts").style.display = "block";
    loadSaleProducts(brandId);
  };

  async function loadSaleProducts(brandId) {
    const saleProductsDiv = document.getElementById("saleProducts");
    saleProductsDiv.innerHTML = "";
    try {
      const resp = await fetch(`${BACKEND_URL}/products`);
      const products = await resp.json();
      const filtered = products.filter(p => p.brandId == brandId && p.stock > 0);
      if (filtered.length === 0) {
        saleProductsDiv.innerHTML = '<div class="col-12 text-center text-muted">No hay productos disponibles para esta marca.</div>';
        return;
      }
      filtered.forEach(prod => {
        saleProductsDiv.innerHTML += `
          <div class="col-md-4 mb-3">
            <div class="card product-card" onclick="openQuantityModal('${prod.id}')">
              <img src="${prod.image}" class="card-img-top" alt="${prod.name}">
              <div class="card-body text-center">
                <h6 class="card-title">${prod.name}</h6>
                <p class="card-text">$${prod.price} - Stock: ${prod.stock}</p>
              </div>
            </div>
          </div>`;
      });
    } catch (error) {
      console.error("Error cargando productos para la venta:", error);
      saleProductsDiv.innerHTML = "<div class='col-12 text-danger'>No se pudieron cargar los productos.</div>";
    }
  }

  window.openQuantityModal = async function(productId) {
    try {
      const resp = await fetch(`${BACKEND_URL}/products`);
      const products = await resp.json();
      selectedProduct = products.find(p => p.id == productId);
      if (selectedProduct) {
        document.getElementById("selectedProductName").textContent =
          selectedProduct.name + " ($" + selectedProduct.price + ")";
        document.getElementById("productQuantity").value = 1;
        $("#quantityModal").modal("show");
      }
    } catch (error) {
      console.error("Error abriendo modal de cantidad:", error);
    }
  };

  function confirmAddProduct() {
    const quantity = parseInt(document.getElementById("productQuantity").value);
    if (isNaN(quantity) || quantity < 1) {
      alert("Ingrese una cantidad válida");
      return;
    }
    if (quantity > selectedProduct.stock) {
      alert("Stock insuficiente para " + selectedProduct.name);
      return;
    }
    addProductToSale(selectedProduct, quantity);
    $("#quantityModal").modal("hide");
  }

  function addProductToSale(prod, qty) {
    const existing = saleItems.find(item => item.productId === prod.id);
    if (existing) {
      if (existing.quantity + qty > prod.stock) {
        alert("No se puede agregar esa cantidad, stock insuficiente");
        return;
      }
      existing.quantity += qty;
    } else {
      saleItems.push({
        productId: prod.id,
        productName: prod.name,
        quantity: qty,
        price: prod.price,
        originalPrice: prod.price,
        roundUpCount: 0,
        roundDownCount: 0
      });
    }
    renderSaleItems();
  }

  function renderSaleItems() {
    const tbody = document.querySelector("#saleItemsTable tbody");
    tbody.innerHTML = "";
    saleItems.forEach((item, index) => {
      const subtotal = (item.quantity * item.price).toFixed(2);
      tbody.innerHTML += `
        <tr>
          <td>${item.productName}</td>
          <td>${item.quantity}</td>
          <td>$${subtotal}</td>
          <td>
            <button class="btn btn-link btn-sm text-primary" onclick="roundItemPrice(${index}, 'down')">
              <i class="bi bi-arrow-down-short"></i>
            </button>
          </td>
          <td>
            <button class="btn btn-link btn-sm text-primary" onclick="roundItemPrice(${index}, 'up')">
              <i class="bi bi-arrow-up-short"></i>
            </button>
          </td>
          <td>
            <button class="btn btn-link btn-sm text-warning" onclick="resetPrice(${index})">
              <i class="bi bi-arrow-counterclockwise"></i>
            </button>
          </td>
          <td>
            <button class="btn btn-link btn-sm text-danger" onclick="removeSaleItem(${index})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>`;
    });
    currentSaleTotal = saleItems.reduce((sum, it) => sum + (it.quantity * it.price), 0);
    document.getElementById("saleTotal").textContent = currentSaleTotal.toFixed(2);
  }

  window.roundItemPrice = function(index, direction) {
    if (!saleItems[index]) return;
    let item = saleItems[index];
    if (direction === 'down') {
      if (item.roundDownCount === 0) {
        item.price = Math.floor(item.price);
        item.roundDownCount = 1;
      } else {
        const mod = item.price % 500;
        item.price = item.price - mod;
        if (item.price < 0) item.price = 0;
      }
      item.roundUpCount = 0;
    } else {
      if (item.roundUpCount === 0) {
        item.price = Math.ceil(item.price);
        item.roundUpCount = 1;
      } else {
        const mod = item.price % 500;
        if (mod === 0) {
          item.price += 500;
        } else {
          item.price += (500 - mod);
        }
      }
      item.roundDownCount = 0;
    }
    renderSaleItems();
  };

  window.resetPrice = function(index) {
    if (!saleItems[index]) return;
    saleItems[index].price = saleItems[index].originalPrice;
    saleItems[index].roundUpCount = 0;
    saleItems[index].roundDownCount = 0;
    renderSaleItems();
  };

  window.removeSaleItem = function(index) {
    saleItems.splice(index, 1);
    renderSaleItems();
  };

  function finalizeSale() {
    if (saleItems.length === 0) {
      alert("No hay items en la venta");
      return;
    }
    if (currentUser.role === "cashier" && !currentSession) {
      alert("Debe abrir caja antes de registrar ventas");
      return;
    }
    showPaymentModal();
  }

  function showPaymentModal() {
    let invoiceHTML = `<h4>Factura</h4>
      <p><strong>Venta ID:</strong> ${Date.now().toString()}</p>
      <p><strong>Fecha:</strong> ${new Date().toLocaleString()}</p>`;
    invoiceHTML += `<table class="table table-sm">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>`;
    saleItems.forEach(item => {
      invoiceHTML += `<tr>
        <td>${item.productName}</td>
        <td>${item.quantity}</td>
        <td>$${item.price.toFixed(2)}</td>
        <td>$${(item.quantity * item.price).toFixed(2)}</td>
      </tr>`;
    });
    invoiceHTML += `</tbody></table>
      <h5>Total: $${currentSaleTotal.toFixed(2)}</h5>
      <p><strong>Monto Recibido:</strong> $<span id="paidAmount"></span></p>
      <p><strong>Devolución:</strong> $<span id="changeAmount"></span></p>`;

    document.getElementById("invoiceDetails").innerHTML = invoiceHTML;
    document.getElementById("amountPaid").value = "";
    document.getElementById("changeDue").textContent = "0.00";
    $("#paymentModal").modal("show");
  }

  function updateChangeDue() {
    const amountPaid = parseFloat(document.getElementById("amountPaid").value) || 0;
    const change = amountPaid - currentSaleTotal;
    document.getElementById("changeDue").textContent = change.toFixed(2);
  }

  async function processPayment() {
    const amountPaid = parseFloat(document.getElementById("amountPaid").value);
    if (isNaN(amountPaid) || amountPaid < currentSaleTotal) {
      alert("El monto recibido es insuficiente.");
      return;
    }
    const change = amountPaid - currentSaleTotal;
    const paymentMethod = document.getElementById("paymentMethod").value;

    // Actualizamos stock en el backend y registramos la venta
    // 1) Verificar stock en el backend (opcional). Aquí haremos:
    //    - Disminuir stock
    //    - Crear registro de venta
    try {
      // 1. Verificar stock de cada producto
      const productResp = await fetch(`${BACKEND_URL}/products`);
      const allProducts = await productResp.json();
      for (let item of saleItems) {
        const found = allProducts.find(p => p.id == item.productId);
        if (!found || found.stock < item.quantity) {
          alert(`Stock insuficiente para ${item.productName}`);
          return;
        }
      }
      // 2. Actualizar stock de cada producto
      for (let item of saleItems) {
        const found = allProducts.find(p => p.id == item.productId);
        const newStock = found.stock - item.quantity;
        await fetch(`${BACKEND_URL}/products/${found.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ stock: newStock })
        });
      }

      // 3. Registrar venta
      const saleRecord = {
        date: new Date().toISOString(),
        cashierId: currentUser.id,
        sessionId: currentSession ? currentSession.id : null,
        items: saleItems,
        total: currentSaleTotal,
        amountPaid,
        change,
        paymentMethod
      };
      await fetch(`${BACKEND_URL}/sales`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(saleRecord)
      });

      // Generar PDF con jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(12);
      doc.text("Factura", 10, y);
      y += 10;
      doc.text(`Venta ID: ${Date.now().toString()}`, 10, y);
      y += 10;
      doc.text(`Fecha: ${new Date().toLocaleString()}`, 10, y);
      y += 10;
      doc.text(`Tipo de Pago: ${paymentMethod}`, 10, y);
      y += 10;
      doc.text("Productos:", 10, y);
      y += 10;
      saleItems.forEach(item => {
        doc.text(
          `${item.productName} - Cant: ${item.quantity} - Precio: $${item.price.toFixed(2)} - Subtotal: $${(item.quantity * item.price).toFixed(2)}`,
          10, y
        );
        y += 10;
      });
      doc.text(`Total: $${currentSaleTotal.toFixed(2)}`, 10, y);
      y += 10;
      doc.text(`Monto Recibido: $${amountPaid.toFixed(2)}`, 10, y);
      y += 10;
      doc.text(`Devolución: $${change.toFixed(2)}`, 10, y);
      doc.save("factura.pdf");

      $("#paymentModal").modal("hide");
      saleItems = [];
      renderSaleItems();
      if (currentSaleBrand) {
        loadSaleProducts(currentSaleBrand);
      }
    } catch (error) {
      console.error("Error procesando venta:", error);
      alert("No se pudo procesar la venta. Ver consola.");
    }
  }

  /******************************************************
   *     Gestión de Reportes (Admin)
   ******************************************************/
  function renderReportesPage() {
    const contentArea = document.getElementById("contentArea");
    contentArea.innerHTML = `
      <h3><i class="fa-solid fa-chart-line"></i> Reportes de Ventas Diarias</h3>
      <div class="form-row mb-3">
        <div class="form-group col-md-4">
          <label>Seleccionar Fecha</label>
          <input type="date" id="reportDate" class="form-control">
        </div>
        <div class="form-group col-md-4">
          <label>Filtrar por Cajero</label>
          <select id="cashierFilter" class="form-control">
            <option value="all">Todos</option>
          </select>
        </div>
        <div class="form-group col-md-4 align-self-end">
          <button id="generateReportBtn" class="btn btn-primary btn-custom">
            <i class="fa-solid fa-file-alt"></i> Generar Reporte
          </button>
        </div>
      </div>
      <div id="reportContent"></div>
      <button id="printReportBtn" class="btn btn-secondary btn-custom" style="display:none;">
        <i class="fa-solid fa-file-export"></i> Exportar a Excel
      </button>`;

    // Cargar cajeros
    loadCashiersForFilter();
    document.getElementById("generateReportBtn").addEventListener("click", function() {
      const reportDate = document.getElementById("reportDate").value;
      if (!reportDate) {
        alert("Seleccione una fecha");
        return;
      }
      const cashierFilter = document.getElementById("cashierFilter").value;
      generateReport(reportDate, cashierFilter);
    });
    document.getElementById("printReportBtn").addEventListener("click", function() {
      const reportDate = document.getElementById("reportDate").value;
      const cashierFilter = document.getElementById("cashierFilter").value;
      exportReportToExcel(reportDate, cashierFilter);
    });
  }

  async function loadCashiersForFilter() {
    try {
      const resp = await fetch(`${BACKEND_URL}/users`);
      const users = await resp.json();
      const cashierSelect = document.getElementById("cashierFilter");
      users
        .filter(u => u.role === "cashier")
        .forEach(c => {
          cashierSelect.innerHTML += `<option value="${c.id}">${c.username}</option>`;
        });
    } catch (error) {
      console.error("Error cargando cajeros para reporte:", error);
    }
  }

  async function generateReport(dateStr, cashierFilter) {
    const reportContent = document.getElementById("reportContent");
    try {
      // 1) Traer todas las ventas
      const respSales = await fetch(`${BACKEND_URL}/sales`);
      let sales = await respSales.json();
      // Filtrar por fecha (date) => dateStr
      // Asumiendo que sale.date es un ISO string, tomamos el substring
      sales = sales.filter(s => s.date.slice(0,10) === dateStr);
      // Filtrar por cajero
      if (cashierFilter !== "all") {
        sales = sales.filter(s => s.cashierId == cashierFilter);
      }

      // 2) Cargar todos los usuarios (para nombre cajero)
      const respUsers = await fetch(`${BACKEND_URL}/users`);
      const users = await respUsers.json();

      // 3) Mostrar ventas
      let totalDaySales = 0;
      let totalStockUsed = 0;

      let html = `<div class="report-section">
                    <h4>Ventas ${cashierFilter === "all" ? "Totales" : "del Cajero"}</h4>`;
      if (sales.length === 0) {
        html += `<p>No hay ventas en esta fecha.</p>`;
      } else {
        sales.forEach(sale => {
          totalDaySales += sale.total;
          let cashier = users.find(u => u.id == sale.cashierId);
          html += `<div class="mb-3">
                     <p><strong>Venta ID:</strong> ${sale.id || "(sin ID)"}
                        | <strong>Cajero:</strong> ${cashier ? cashier.username : 'Desconocido'}
                        | <strong>Hora:</strong> ${new Date(sale.date).toLocaleTimeString()}
                        | <strong>Total:</strong> $${(sale.total || 0).toFixed(2)}</p>
                     <p><strong>Forma de pago:</strong> ${sale.paymentMethod || 'N/A'}</p>
                     <table class="table table-sm">
                       <thead>
                         <tr>
                           <th>Producto</th>
                           <th>Cantidad</th>
                           <th>Precio</th>
                           <th>Subtotal</th>
                         </tr>
                       </thead>
                       <tbody>`;
          if (sale.items) {
            sale.items.forEach(item => {
              totalStockUsed += item.quantity;
              html += `<tr>
                         <td>${item.productName}</td>
                         <td>${item.quantity}</td>
                         <td>$${item.price.toFixed(2)}</td>
                         <td>$${(item.quantity * item.price).toFixed(2)}</td>
                       </tr>`;
            });
          }
          html += `</tbody></table></div>`;
        });
        html += `<p><strong>Total del Día:</strong> $${totalDaySales.toFixed(2)}</p>`;
        html += `<p><strong>Total de Stock Consumido:</strong> ${totalStockUsed} unidades</p>`;
      }
      html += `</div>`;

      // No hay ejemplo de "Balance de Caja" real en el backend, ni de "CashSessions" en la BD,
      // así que lo omitimos o lo dejamos en blanco
      html += `<div class="report-section">
                 <h4>Balance de Caja</h4>
                 <p>No hay información de caja en tiempo real.</p>
               </div>`;

      // 4) Stock actual
      const respProds = await fetch(`${BACKEND_URL}/products`);
      const products = await respProds.json();
      html += `<div class="report-section">
                 <h4>Stock Actual</h4>
                 <table class="table table-bordered">
                   <thead>
                     <tr>
                       <th>Producto</th>
                       <th>Stock</th>
                     </tr>
                   </thead>
                   <tbody>`;
      products.forEach(prod => {
        html += `<tr><td>${prod.name}</td><td>${prod.stock}</td></tr>`;
      });
      html += `</tbody></table></div>`;

      reportContent.innerHTML = html;
      document.getElementById("printReportBtn").style.display = "inline-block";
    } catch (error) {
      console.error("Error generando reporte:", error);
      reportContent.innerHTML = "<div class='text-danger'>Error generando reporte.</div>";
    }
  }

  async function exportReportToExcel(dateStr, cashierFilter) {
    // Se repite la lógica de arriba para traer la info
    try {
      const respSales = await fetch(`${BACKEND_URL}/sales`);
      let sales = await respSales.json();
      sales = sales.filter(s => s.date.slice(0,10) === dateStr);
      if (cashierFilter !== "all") {
        sales = sales.filter(s => s.cashierId == cashierFilter);
      }

      const respUsers = await fetch(`${BACKEND_URL}/users`);
      const users = await respUsers.json();

      const respProducts = await fetch(`${BACKEND_URL}/products`);
      const allProducts = await respProducts.json();

      // 1) Hoja de Ventas
      const ventasData = [];
      ventasData.push(["Venta ID", "Cajero", "Hora", "Total", "Tipo de Pago", "Items y Stock"]);

      sales.forEach(sale => {
        const cashier = users.find(u => u.id == sale.cashierId);
        const itemsInfo = sale.items.map(item => {
          const product = allProducts.find(p => p.id == item.productId);
          const finalStock = product ? product.stock : "N/A";
          return `${item.productName} x${item.quantity} (Stock: ${finalStock})`;
        }).join("; ");
        ventasData.push([
          sale.id || "(sin ID)",
          cashier ? cashier.username : "Desconocido",
          new Date(sale.date).toLocaleTimeString(),
          (sale.total || 0).toFixed(2),
          sale.paymentMethod || "N/A",
          itemsInfo
        ]);
      });

      // 2) Caja (no implementado, se haría otra hoja si tuvieras la info)
      const cajaData = [];
      cajaData.push(["(Sin datos de caja implementados)"]);

      // 3) Stock
      const stockData = [];
      stockData.push(["Producto", "Stock"]);
      allProducts.forEach(prod => {
        stockData.push([prod.name, prod.stock]);
      });

      // Construir libro Excel
      const wb = XLSX.utils.book_new();
      const wsVentas = XLSX.utils.aoa_to_sheet(ventasData);
      XLSX.utils.book_append_sheet(wb, wsVentas, "Ventas");

      const wsCaja = XLSX.utils.aoa_to_sheet(cajaData);
      XLSX.utils.book_append_sheet(wb, wsCaja, "Caja");

      const wsStock = XLSX.utils.aoa_to_sheet(stockData);
      XLSX.utils.book_append_sheet(wb, wsStock, "Stock");

      const filename = `Reporte_${dateStr}_${cashierFilter === "all" ? "Todos" : cashierFilter}.xlsx`;
      XLSX.writeFile(wb, filename);
    } catch (error) {
      console.error("Error exportando a Excel:", error);
      alert("No se pudo exportar el reporte a Excel.");
    }
  }

  /******************************************************
   * Lectura de Código de Barras (Teclado)
   ******************************************************/
  function globalKeyHandler(e) {
    if (e.altKey) {
      const k = e.key.toLowerCase();
      switch (k) {
        case 'c': 
          if (currentUser && currentUser.role === "cashier") {
            e.preventDefault();
            loadPage("caja");
          }
          break;
        case 'v': 
          if (currentUser && currentUser.role === "cashier") {
            e.preventDefault();
            loadPage("ventas");
          }
          break;
        case 'p': 
          if (currentUser && currentUser.role === "admin") {
            e.preventDefault();
            loadPage("productos");
          }
          break;
      }
    }
    if (barcodeTimeout) clearTimeout(barcodeTimeout);
    if (e.ctrlKey || e.altKey) return;
    if (e.key === "Enter") {
      if (barcodeBuffer.trim() !== "") { findProductByBarcode(barcodeBuffer.trim()); }
      barcodeBuffer = "";
      return;
    }
    if (e.key.length === 1) { barcodeBuffer += e.key; }
    barcodeTimeout = setTimeout(() => { barcodeBuffer = ""; }, 300);
  }

  async function findProductByBarcode(code) {
    try {
      const resp = await fetch(`${BACKEND_URL}/products`);
      const products = await resp.json();
      const match = products.find(p => p.barcode && p.barcode.trim() === code);
      if (!match) {
        alert(`No se encontró producto con código de barras: ${code}`);
        return;
      }
      if (currentUser && currentUser.role === "cashier" && currentSession) {
        addProductToSale(match, 1);
      } else {
        alert(`Producto: ${match.name} encontrado, pero no hay caja abierta o usuario cajero`);
      }
    } catch (error) {
      console.error("Error buscando producto por código:", error);
    }
  }
  </script>
</body>
</html>
